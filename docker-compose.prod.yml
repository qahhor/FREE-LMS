version: '3.8'

# =============================================================================
# FREE LMS - Production Docker Compose
# 32 Microservices + Infrastructure
# =============================================================================

services:
  # ============= Infrastructure =============

  # Service Discovery
  discovery-server:
    image: freelms/discovery-server:1.0.0
    container_name: lms-discovery
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - lms-network

  # Configuration Server
  config-server:
    image: freelms/config-server:1.0.0
    container_name: lms-config
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      discovery-server:
        condition: service_healthy
    networks:
      - lms-network

  # API Gateway
  api-gateway:
    image: freelms/api-gateway:1.0.0
    container_name: lms-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - discovery-server
      - config-server
    networks:
      - lms-network

  # ============= Databases =============

  postgres:
    image: postgres:16-alpine
    container_name: lms-postgres
    environment:
      POSTGRES_USER: freelms
      POSTGRES_PASSWORD: ${DB_PASSWORD:-freelms_secret}
      POSTGRES_MULTIPLE_DATABASES: users,courses,enrollments,assessments,payments,analytics,certificates,forums,calendars,messages,reports,gamification,social,admin,proctoring,assignments,bookings,audit,lti,bots
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - lms-network

  mongodb:
    image: mongo:7
    container_name: lms-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: freelms
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-freelms_secret}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"
    networks:
      - lms-network

  redis:
    image: redis:7-alpine
    container_name: lms-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-freelms_secret}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - lms-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: lms-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - lms-network

  # ============= Message Queue =============

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: lms-kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - kafka_data:/var/lib/kafka/data
    ports:
      - "9092:9092"
    networks:
      - lms-network

  # ============= Object Storage =============

  minio:
    image: minio/minio
    container_name: lms-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-freelms}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-freelms_secret}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - lms-network

  # ============= Core Services =============

  user-service:
    image: freelms/user-service:1.0.0
    container_name: lms-user
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/users
      - SPRING_DATASOURCE_USERNAME=freelms
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-freelms_secret}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_REDIS_HOST=redis
    depends_on:
      - postgres
      - redis
      - discovery-server
    networks:
      - lms-network

  course-service:
    image: freelms/course-service:1.0.0
    container_name: lms-course
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/courses
      - SPRING_DATASOURCE_USERNAME=freelms
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-freelms_secret}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  content-service:
    image: freelms/content-service:1.0.0
    container_name: lms-content
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATA_MONGODB_URI=mongodb://freelms:${MONGO_PASSWORD:-freelms_secret}@mongodb:27017/content?authSource=admin
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - mongodb
      - minio
      - discovery-server
    networks:
      - lms-network

  assessment-service:
    image: freelms/assessment-service:1.0.0
    container_name: lms-assessment
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/assessments
      - SPRING_DATASOURCE_USERNAME=freelms
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-freelms_secret}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  enrollment-service:
    image: freelms/enrollment-service:1.0.0
    container_name: lms-enrollment
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/enrollments
      - SPRING_DATASOURCE_USERNAME=freelms
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-freelms_secret}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  # ============= Communication Services =============

  notification-service:
    image: freelms/notification-service:1.0.0
    container_name: lms-notification
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/notifications
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  messaging-service:
    image: freelms/messaging-service:1.0.0
    container_name: lms-messaging
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/messages
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  forum-service:
    image: freelms/forum-service:1.0.0
    container_name: lms-forum
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/forums
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Business Services =============

  payment-service:
    image: freelms/payment-service:1.0.0
    container_name: lms-payment
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/payments
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  certificate-service:
    image: freelms/certificate-service:1.0.0
    container_name: lms-certificate
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/certificates
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Analytics & Reporting =============

  analytics-service:
    image: freelms/analytics-service:1.0.0
    container_name: lms-analytics
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/analytics
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  reporting-service:
    image: freelms/reporting-service:1.0.0
    container_name: lms-reporting
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/reports
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Search & Media =============

  search-service:
    image: freelms/search-service:1.0.0
    container_name: lms-search
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_ELASTICSEARCH_URIS=http://elasticsearch:9200
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - elasticsearch
      - kafka
      - discovery-server
    networks:
      - lms-network

  media-processing-service:
    image: freelms/media-processing-service:1.0.0
    container_name: lms-media
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MINIO_ENDPOINT=http://minio:9000
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - minio
      - kafka
      - discovery-server
    networks:
      - lms-network

  file-storage-service:
    image: freelms/file-storage-service:1.0.0
    container_name: lms-storage
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MINIO_ENDPOINT=http://minio:9000
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - minio
      - discovery-server
    networks:
      - lms-network

  # ============= Events & Calendar =============

  event-service:
    image: freelms/event-service:1.0.0
    container_name: lms-event
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/events
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  calendar-service:
    image: freelms/calendar-service:1.0.0
    container_name: lms-calendar
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/calendars
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Engagement Services =============

  gamification-service:
    image: freelms/gamification-service:1.0.0
    container_name: lms-gamification
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/gamification
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  social-learning-service:
    image: freelms/social-learning-service:1.0.0
    container_name: lms-social
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/social
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Content Authoring =============

  authoring-service:
    image: freelms/authoring-service:1.0.0
    container_name: lms-authoring
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/authoring
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - postgres
      - minio
      - discovery-server
    networks:
      - lms-network

  # ============= Assessment & Proctoring =============

  proctoring-service:
    image: freelms/proctoring-service:1.0.0
    container_name: lms-proctoring
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/proctoring
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - postgres
      - minio
      - discovery-server
    networks:
      - lms-network

  assignment-review-service:
    image: freelms/assignment-review-service:1.0.0
    container_name: lms-assignment
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/assignments
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Resource Management =============

  resource-booking-service:
    image: freelms/resource-booking-service:1.0.0
    container_name: lms-booking
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/bookings
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  # ============= Compliance & Integration =============

  audit-logging-service:
    image: freelms/audit-logging-service:1.0.0
    container_name: lms-audit
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/audit
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - kafka
      - discovery-server
    networks:
      - lms-network

  lti-service:
    image: freelms/lti-service:1.0.0
    container_name: lms-lti
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/lti
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  integration-service:
    image: freelms/integration-service:1.0.0
    container_name: lms-integration
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/integrations
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  # ============= Bot & Mobile =============

  bot-platform-service:
    image: freelms/bot-platform-service:1.0.0
    container_name: lms-bot
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/bots
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

  mobile-api-service:
    image: freelms/mobile-api-service:1.0.0
    container_name: lms-mobile
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - discovery-server
    networks:
      - lms-network

  admin-service:
    image: freelms/admin-service:1.0.0
    container_name: lms-admin
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/admin
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      - postgres
      - discovery-server
    networks:
      - lms-network

# ============= Volumes =============
volumes:
  postgres_data:
  mongo_data:
  redis_data:
  es_data:
  kafka_data:
  minio_data:

# ============= Networks =============
networks:
  lms-network:
    driver: bridge
